<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My PWA</title>

  <!-- ✅ ĐÚNG: link manifest -->
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- Theme color -->
  <meta name="theme-color" content="#2563eb" />

  <!-- ✅ iOS A2HS: giúp Add to Home Screen “ra dáng app” -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="MyPWA" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- ✅ iOS icon (khuyến nghị thêm) -->
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 18px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #cbd5e1; background: #2563eb; color: #fff; cursor: pointer; }
    .muted { color: #475569; }

    #iosHelpOverlay[hidden] { display: none; }
    #iosHelpOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; padding: 16px;
    }
    #iosHelpBox {
      width: 100%; max-width: 460px; background: #fff; border-radius: 14px;
      padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    #closeIosBtn { width: 100%; margin-top: 10px; background: #0f172a; border: none; }
  </style>
</head>

<body>
  <h1>My PWA</h1>
  <p class="muted" id="debug"></p>

  <!-- ✅ NÚT LUÔN HIỆN (không hidden) -->
  <button id="installBtn">Cài đặt</button>
  <p class="muted" id="status"></p>

  <div id="iosHelpOverlay" hidden>
    <div id="iosHelpBox">
      <h3 style="margin:0 0 8px;">Cài lên Màn hình chính (iPhone/iPad)</h3>
      <ol style="margin:0; padding-left: 18px;">
        <li>Mở trang bằng <b>Safari</b> (khuyến nghị).</li>
        <li>Nhấn <b>Share</b> (ô vuông có mũi tên lên).</li>
        <li>Chọn <b>Add to Home Screen</b> → <b>Add</b>.</li>
      </ol>
      <button id="closeIosBtn">Đóng</button>
    </div>
  </div>

  <script>
    // SW: cần HTTPS, GitHub Pages đáp ứng. [5](https://github.com/microsoft/PowerToys/issues/36241)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }

    const installBtn = document.getElementById("installBtn");
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");
    const iosOverlay = document.getElementById("iosHelpOverlay");
    const closeIosBtn = document.getElementById("closeIosBtn");

    const isIOS = () => /iphone|ipad|ipod/i.test(navigator.userAgent);

    // Detect standalone: display-mode MQ + navigator.standalone (iOS). [7](https://stackoverflow.com/questions/30413244/why-do-service-workers-only-work-over-https)[6](https://www.w3.org/TR/appmanifest/)
    const isStandalone = () =>
      (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
      window.navigator.standalone === true;

    function setStatus(msg) { statusEl.textContent = msg || ""; }

    // Debug info để bạn biết vì sao nút bị ẩn (nếu có)
    debugEl.textContent =
      `iOS=${isIOS()} | standalone=${isStandalone()} | navigator.standalone=${window.navigator.standalone}`;

    // ✅ CHỈ ẩn nút nếu thật sự đang chạy kiểu “đã cài”
    if (isStandalone()) {
      installBtn.hidden = true;
      setStatus("Đang chạy ở chế độ đã cài đặt ✅");
   -based. [2](https://docs.github.com/en/pages/getting-started-with-github-pages/securing-your-github-pages-site-with-https)[8](https://christianheilmann.com/2022/01/13/turning-a-github-page-into-a-progressive-web-app/)
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      setStatus("Thiết bị hỗ trợ cài đặt. Bấm 'Cài đặt' để tiếp tục.");
    });

    window.addEventListener("appinstalled", () => {
      deferredPrompt = null;
      installBtn.hidden = true;
      setStatus("Đã cài đặt xong ✅");
    });

    installBtn.addEventListener("click", async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt(); // [2](https://docs.github.com/en/pages/getting-started-with-github-pages/securing-your-github-pages-site-with-https)[8](https://christianheilmann.com/2022/01/13/turning-a-github-page-into-a-progressive-web-app/)
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        return;
      }

      // iOS không có install prompt/banner -> show hướng dẫn. [1](https://dev.to/austinwdigital/intro-to-service-workers-best-practices-threat-mitigation-59a3)[3](https://caniuse.com/mdn-css_at-rules_media_display-mode_standalone)[4](https://stackoverflow.com/questions/46228604/pwa-on-github-pages)
      if (isIOS()) {
        iosOverlay.hidden = false;
        setStatus("iOS không có prompt cài đặt tự động. Hãy làm theo hướng dẫn.");
        return;
      }

      setStatus("Trình duyệt không hỗ trợ prompt cài đặt. Hãy dùng menu 'Install app' / 'Add to Home Screen'.");
    });

    closeIosBtn.addEventListener("click", () => iosOverlay.hidden = true);
  </script>
</body>
</html>
``
