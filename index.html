<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My PWA</title>

  <!-- Manifest -->
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- Theme color (Chrome/Android UI) -->
  <meta name="theme-color" content="#2563eb" />

  <!-- iOS: gi√∫p ‚ÄúAdd to Home Screen‚Äù hi·ªÉn th·ªã nh∆∞ web app -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="MyPWA" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <!-- G·ª£i √Ω th√™m (kh√¥ng b·∫Øt bu·ªôc): status bar style -->
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 18px; }
    .card { max-width: 720px; margin: 0 auto; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #cbd5e1; background: #2563eb; color: #fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .muted { color: #475569; }

    /* Modal iOS */
    #iosHelpOverlay[hidden] { display: none; }
    #iosHelpOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; padding: 16px;
    }
    #iosHelpBox {
      width: 100%; max-width: 460px; background: #fff; border-radius: 14px;
      padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    #closeIosBtn {
      width: 100%; margin-top: 10px; background: #0f172a;
      border: none;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>My PWA on GitHub Pages</h1>
    <p class="muted">
      N√∫t ‚ÄúC√†i ƒë·∫∑t‚Äù s·∫Ω hi·ªán prompt tr√™n Android/desktop Chromium; tr√™n iPhone s·∫Ω hi·ªán h∆∞·ªõng d·∫´n Add to Home Screen.
    </p>

    <button id="installBtn">C√†i ƒë·∫∑t</button>
    <p id="status" class="muted"></p>
  </div>

  <!-- iOS help modal -->
  <div id="iosHelpOverlay" hidden>
    <div id="iosHelpBox">
      <h3 style="margin:0 0 8px;">C√†i l√™n M√†n h√¨nh ch√≠nh (iPhone/iPad)</h3>
      <ol style="margin:0; padding-left: 18px;">
        <li>M·ªü trang b·∫±ng <b>Safari</b> (khuy·∫øn ngh·ªã).</li>
        <li>Nh·∫•n n√∫t <b>Share</b> (√¥ vu√¥ng c√≥ m≈©i t√™n l√™n).</li>
        <li>Ch·ªçn <b>Add to Home Screen</b> ‚Üí <b>Add</b>.</li>
      </ol>
      <button id="closeIosBtn">ƒê√≥ng</button>
    </div>
  </div>

  <script>
    // ========== 1) Register Service Worker (c·∫ßn cho PWA) ==========
    // Service Worker ch·∫°y tr√™n HTTPS (GitHub Pages ok) iceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }

    // ========== 2) Helpers ==========
    const installBtn = document.getElementById("installBtn");
    const statusEl = document.getElementById("status");
    const iosOverlay = document.getElementById("iosHelpOverlay");
    const closeIosBtn = document.getElementById("closeIosBtn");

    const isIOS = () => /iphone|ipad|ipod/i.test(navigator.userAgent);

    // Detect ƒëang ch·∫°y ·ªü ch·∫ø ƒë·ªô ‚Äúƒë√£ c√†i‚Äù (standalone/app mode)
    // - display-mode MQ l√† c√°ch chung [9](https://stackoverflow.com/questions/30413244/why-do-service-workers-only-work-over-https)[10](https://developers.google.com/codelabs/pwa-training/pwa04--prompt-measure-install)
    // - iOS c√≥ navigator.standalone (th∆∞·ªùng d√πng ƒë·ªÉ detect homescreen mode) [11](https://www.w3.org/TR/appmanifest/)
    const isStandalone = () =>
      (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
      window.navigator.standalone === true;

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    function updateInstallButtonVisibility() {
      // N·∫øu ƒë√£ ch·∫°y ·ªü app mode th√¨ ·∫©n n√∫t c√†i ƒë·∫∑t
      if (isStandalone()) {
        installBtn.hidden = true;
        setStatus("App ƒëang ch·∫°y ·ªü ch·∫ø ƒë·ªô ƒë√£ c√†i ƒë·∫∑t ‚úÖ");
      } else {
        installBtn.hidden = false;
      }
    }

    // ========== 3) Chromium install prompt ==========
    // beforeinstallprompt: ch·ªâ Chromium-based (MDN c·∫£nh b√°o non-standard) [1](https://docs.github.com/en/pages/getting-started-with-github-pages/securing-your-github-pages-site-with-https)[2](https://christianheilmann.com/2022/01/13/turning-a-github-page-into-a-progressive-web-app/)
    let deferredPrompt = null;

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();       // ch·∫∑n UI m·∫∑c ƒë·ªãnh
      deferredPrompt = e;       // l∆∞u l·∫°i ƒë·ªÉ g·ªçi khi user b·∫•m n√∫t
      setStatus("Thi·∫øt b·ªã h·ªó tr·ª£ c√†i ƒë·∫∑t. B·∫•m 'C√†i ƒë·∫∑t' ƒë·ªÉ ti·∫øp t·ª•c.");
    });

    window.addEventListener("appinstalled", () => {
      setStatus("ƒê√£ c√†i ƒë·∫∑t xong ‚úÖ");
      deferredPrompt = null;
      updateInstallButtonVisibility();
    });

    // ========== 4) Button click behavior ==========
    installBtn.addEventListener("click", async () => {
      // N·∫øu c√≥ deferredPrompt => Android/desktop Chromium c√†i ƒë·∫∑t th·∫≠t
      if (deferredPrompt) {
        deferredPrompt.prompt(); // m·ªü prompt c√†i ƒë·∫∑t [1](https://docs.github.com/en/pages/getting-started-with-github-pages/securing-your-github-pages-site-with-https)[2](https://christianheilmann.com/2022/01/13/turning-a-github-page-into-a-progressive-web-app/)
        const choice = await deferredPrompt.userChoice;
        if (choice && choice.outcome === "accepted") {
          setStatus("B·∫°n ƒë√£ ch·∫•p nh·∫≠n c√†i ƒë·∫∑t üéâ");
        } else {
          setStatus("B·∫°n ƒë√£ hu·ª∑ c√†i ƒë·∫∑t.");
        }
        deferredPrompt = null;
        return;
      }

      // iOS: kh√¥ng c√≥ install prompt/banner ‚Üí show h∆∞·ªõng d·∫´n A2HS [3](https://dev.to/austinwdigital/intro-to-service-workers-best-practices-threat-mitigation-59a3)[4](https://caniuse.com/mdn-css_at-rules_media_display-mode_standalone)[5](https://stackoverflow.com/questions/46228604/pwa-on-github-pages)
      if (isIOS()) {
        iosOverlay.hidden = false;
        setStatus("iOS kh√¥ng c√≥ prompt c√†i ƒë·∫∑t t·ª± ƒë·ªông. H√£y l√†m theo h∆∞·ªõng d·∫´n.");
        return;
      }

      // Fallback cho c√°c tr√¨nh duy·ªát kh√°c
      setStatus("Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ prompt c√†i ƒë·∫∑t. H√£y d√πng menu c·ªßa tr√¨nh duy·ªát ƒë·ªÉ 'Install app' / 'Add to Home Screen'.");
    });

    closeIosBtn.addEventListener("click", () => {
      iosOverlay.hidden = true;
    });

    // initial state
    updateInstallButtonVisibility();
  </script>
</body>
</html>
